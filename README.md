# Серверная часть приложения SyncGad

## Оглавление

1. [Структура проекта](#структура-проекта-и-назначение-отдельных-файлов)
2. [Назначение серверной части](#назначение-серверной-части)
3. [Архитектура базы данных](#архитектура-базы-данных)
4. [Содержимое отдельных файлов](#содержимое-отдельных-файлов)

## Структура проекта и назначение отдельных файлов

```angular2html
Server part
         ├── db_control
                  ├── database_actions.py   служит для описания функций для взаимодействия с базой данных
                  ├── files_actions.py      служит для описания функций для работы с архивами: их сравнения друг с другом, слияния двух в один
                  └── init.py               служит для подключения к базе данных
         ├── images
                  └── database.png          схема базы данных, вставлена в файл README.md
         ├── server_control
                  ├── init.py               служит для инициализации сервера, определения его конфигураций
                  └── requests_handler.py   служит для описания функций обработки входящий http-запросов
         ├── .env                           содержит переменные окружения для подключения к базе данных
         ├── docker-compose.yaml            служит для создания более удобного запуска контейнера сервера
         ├── Dockerfile                     служит для определения инструкций докера для запуска проекта
         ├── main.py                        является исполняемым файлом, запускающим сервер
         ├── README.md
         ├── requirements.txt               содержит список всех библиотек и их версий, требущих дополнительной установки
         └── wait-for-postgres.sh           содежрит скрипт для корректного запуска докер-контейнера
```

## Назначение серверной части

Разрабатываемое приложение состоит из двух частей: **[клиентской](https://github.com/bmstu-iu8-2021-project/psync-client)** 
и **серверной**. В клиентской части пользователь выполняет некоторые действия, в результате которых на сервер приходят 
**http-запросы** для получения или сохранения данных (текстовая информация, файлы, собранные в архивы). Файлы хранятся 
в томе, примонтированном к докер-контейнеру, в котором сервер запускается. Текстовая информация объединена в базу данных 
**coursework**, взаимодействие с ней происходит при помощи PostgreSQL.

## Архитектура базы данных

База данных состоит из шести таблиц:

- person (содержит логины, почты и пароли пользователей)
- hosts (содержит mac-адреса пользователей)
- agent (содержит id таблиц person и hosts, что связывает каждого пользоватея с конкретными mac-адресами)
- resources (содержит id таблицы agent и локальный путь к сохраняемой папке, что связывает конкретного пользователя,
  устройство и сохраняемую папку)
- versions (содержит id таблицы resources, имя конкретной версии, дату и время создания этого сохранения, флаг,
  говорящий о том, является ли эта векрсия актуальной, и путь на сервере до архива, содержащего эту папку)
- replica_set (содержит id двух записей табцы resources, что связывает папки двух пользователей, которые они
  синхронизируют)

Схема базы данных приведена на следующем изображении:

![Схема базы данных](images/database.png "Схема базы данных")

## Содержимое отдельных файлов

Рассмотрим содержимое каждого .py-файла проекта:
1. db_control/database_actions.py
   - функция auth
   - функция add_host
   - функция find_login
   - функция find_email
   - функция get_email
   - функция get_password
   - функция add_user
   - функция delete_user
   - функция change
   - функция get_person_id
   - функция get_host_id
   - функция get_agent_id
   - функция add_folder
   - функция delete_version
   - функция find_version
   - функция get_folders
   - функция make_actual
   - функция make_no_actual
   - функция get_resources_id
   - функция get_actual_version
   - функция download_folder
   - функция synchronize
   - функция get_synchronized
   - функция terminate_sync
   - функция get_difference
   - функция check_synchronized
   - функция update_version
   - функция synchronize_folder
2. db_control/files_actions.py
   - функция get_difference
   - функция get_dict
   - функция compare_archives
   - функция unzip_with_meta
   - функция merge
3. db_control/init.py
   - функция connect
   - функция create
   - функция close
4. server_control/init.py
5. server_control/requests_handler.py
   - декоратор token_required
   - функция auth
   - функция find_login
   - функция find_email
   - функция get_email
   - функция get_password
   - функция add_user
   - функция delete_user
   - функция change_email
   - функция change_password
   - функция add_version
   - функция upload_folder
   - функция delete_version
   - функция find_version
   - функция get_folders